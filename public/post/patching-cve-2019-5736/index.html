<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Patching Runc Vulnerability (CVE-2019-5736) - ~/mattjmcnaughton/blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="~/mattjmcnaughton/blog" rel="home">
				<div class="logo__title">~/mattjmcnaughton/blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/gpg/">
				
				<span class="menu__text">GPG</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Patching Runc Vulnerability (CVE-2019-5736)</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2019-02-16T00:00:00">2019-02-16</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/projects/" rel="category">Projects</a>
	</span>
</div></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/lock.jpg" alt="Patching Runc Vulnerability (CVE-2019-5736)">
		</figure><div class="content post__content clearfix">
			<p>So far, most of our posts on this blog have been about the exciting parts of running
our own Kubernetes cluster. But, running a Kubernetes cluster isn&rsquo;t all
having fun deploying applications. We also have to be responsible for system maintenance.
That need became particularly apparent recently with the release of
<a href="https://kubernetes.io/blog/2019/02/11/runc-and-cve-2019-5736/">CVE-2019-5736</a>
on 2/11/19.</p>
<h2 id="what-is-cve-2019-5736">What is CVE-2019-5736</h2>
<iframe src="https://giphy.com/embed/7K3p2z8Hh9QOI" width="480" height="270"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/dog-what-confused-7K3p2z8Hh9QOI">via GIPHY</a></p>
<p>CVE-2019-5736 is the CVE for a container escape vulnerability discovered in
<a href="https://github.com/opencontainers/runc">runc</a>. Runc is a CLI tool which
runs containers in accordance with the <a href="https://www.opencontainers.org/">Open Containers Initiative
(OCI)</a> spec.</p>
<p>As we said, this vulnerability is a container escape
vulnerability. Essentially, a process running as root inside the container can
exploit a bug in runc to gain root privileges on the host running the container.
Once the malicious process has root privileges on the host, it can pretty much
do whatever it wants.</p>
<p>This vulnerability is particularly concerning as it is relatively common to run
public container images on a k8s cluster. Until this vulnerability is patched,
we&rsquo;re placing high levels of trust in the creator of the public container image that
they aren&rsquo;t doing anything malicious, and also trusting the container image
isn&rsquo;t tampered with when pulled down to run on our k8s cluster.</p>
<p>This <a href="https://kubernetes.io/blog/2019/02/11/runc-and-cve-2019-5736/">blog post</a>
from the k8s team offers even greater detail on runc and the vulnerability in
question.</p>
<h2 id="what-is-cve-2019-5736s-impact">What is CVE-2019-5736&rsquo;s impact?</h2>
<p>As users, it is rare that we would ever interact with runc directly. So, we may
be tempted to think this vulnerability won&rsquo;t impact us.
However, runc is a foundational component of Docker, as
Docker uses runc to do the heavy lifting of Linux container interactions. Thus,
anyone using Docker to run containers is vulnerable.
Additionally, most k8s clusters, including ours, use Docker as the tool for
actually running container images as containers.
As a result, we want to be sure that we address this vulnerability both on our
local systems where we interact with docker directly, and on our k8s cluster.</p>
<h2 id="addressing-cve-2019-5736">Addressing CVE-2019-5736</h2>
<iframe src="https://giphy.com/embed/lVBtp4SRW6rvDHf1b6" width="480"
height="320" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/lVBtp4SRW6rvDHf1b6">via GIPHY</a></p>
<p>As mentioned in the previous section, we need to patch both our local Docker
installs and our k8s cluster.</p>
<h3 id="patching-local-docker-installs">Patching local Docker installs</h3>
<p>Patching the local Docker install will be operating system dependent.
However, regardless of operating system, we need to ensure we are using a
version of the Docker engine which address the vulnerability. Docker lists the
versions addressing the vulnerability in <a href="https://blog.docker.com/2019/02/docker-security-update-cve-2018-5736-and-container-security-best-practices/">this blog
post</a>.</p>
<p>We do our development on a Ubuntu-based distro, and install <code>docker-ce</code> via
Docker&rsquo;s <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">repositories</a>,
so our update process is the following:</p>
<pre tabindex="0"><code>$ sudo apt update
$ sudo apt install --only-upgrade docker-ce
</code></pre><p>When we run <code>docker version</code>, we should see a
<code>Server.Engine.Version</code> which is greater than or equal to the versions
addressing the vulnerability listed in the blog post.</p>
<h3 id="patching-k8s-cluster-w-kops">Patching k8s cluster (w/ kops)</h3>
<p>Our method for creating/managing our k8s cluster dictates our method for
ensuring our cluster uses a version of Docker which addresses the vulnerability.</p>
<p>Our cluster was created using <a href="https://github.com/kubernetes/kops">kops</a>, so
we will discuss how to use kops to ensure our cluster is protected from this
vulnerability.</p>
<p>The <a href="https://github.com/kubernetes/kops/blob/master/docs/advisories/cve_2019_5736.md">kops advisory for
CVE-2019-5736</a>
discusses a number of mitigations. We decided the best one for us was upgrading
to kops 1.11.1.</p>
<p><strong>Before following the rest of this blog post, please check that both your
current kops and k8s version support you updating to 1.11.1.</strong></p>
<p>Kops 1.11.1 includes a number of mitigations for the CVE,
but the most important component is kops configures our
cluster to start using Docker 18.06.3, which addresses the CVE, instead of 17.03.2, which does not.</p>
<p>If, after installing kops 1.11.1, we run <code>kops update cluster</code>, we&rsquo;ll see the
<code>LaunchConfiguration</code> for our hosts now specifies the new Docker version. We
then run <code>kops update cluster --yes</code> to actually apply these changes.</p>
<p>These changes will require a rolling update to actually take effect, so we want
to run <code>kops rolling-update cluster</code> to preview the change, and <code>kops rolling-update cluster --yes</code> to enact the change.</p>
<p>After doing so, we should be able to ssh into our master, run <code>docker version</code>
and see we are using a supported version, as we specify below:</p>
<pre tabindex="0"><code>$ ssh admin@k8s-master-ip
$ sudo docker version # should be 18.06.3
</code></pre><p>Thanks to the upgraded Docker, our k8s cluster is no longer vulnerable to CVE-2019-5736.
As mentioned above, the [kops advisory for CVE-2019-5736]
(<a href="https://github.com/kubernetes/kops/blob/master/docs/advisories/cve_2019_5736.md">https://github.com/kubernetes/kops/blob/master/docs/advisories/cve_2019_5736.md</a>)
provides a number of different mitigations, so upgrading Docker via upgrading
kops to 1.11.1 is not the only way to address this CVE.</p>
<h2 id="preventing-these-types-of-problems">Preventing these types of problems</h2>
<iframe src="https://giphy.com/embed/q0fEAgtjX6nOE" width="480" height="480"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/andy-samberg-seth-meyers-pharrell-q0fEAgtjX6nOE">via
GIPHY</a></p>
<p>As mentioned in the explanation section, this vulnerability could only be
exploited by processes running as root within the container. Fortunately, it is very rarely a
good idea for a process to run as root within the container, so another way to
address this vulnerability is to ensure all the containers we run on our k8s
cluster conform to the best practice of running as non-root. This [blog post]
(<a href="https://kubernetes.io/blog/2018/07/18/11-ways-not-to-get-hacked/#8-run-containers-as-a-non-root-user">https://kubernetes.io/blog/2018/07/18/11-ways-not-to-get-hacked/#8-run-containers-as-a-non-root-user</a>)
from the k8s team gives more instruction on how to enforce containers running as
non-root at a cluster wide level. The majority of popular images
do not run as root by default, so this guideline should not be particularly
difficult to enforce.</p>
<p>Additionally, this vulnerability serves as a good reminder to only run images
that we trust on our Kubernetes cluster.</p>
<p>While we should still patch our clusters regardless, vulnerabilities such as CVE-2019-5736
serve as a good reminder that following best practices can have important
preventive security ramifications.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Hooray, both our local Docker and k8s clusters are secure against CVE-2019-5736!
A huge thanks to the members of the kops, k8s, Docker, and runc communities for
their work on making patches available in a timely manner.</p>
<iframe src="https://giphy.com/embed/IcGkqdUmYLFGE" width="480" height="270"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/IcGkqdUmYLFGE">via GIPHY</a></p>

		</div>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/deploying-next-cloud-on-k8s/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Deploying Nextcloud on k8s</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/blog-is-now-https/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">mattjmcnaughton.com is now https</p></a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/mattjmcnaughton" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:me@mattjmcnaughton.com">
				<svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>me@mattjmcnaughton.com</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 ~/mattjmcnaughton/blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>