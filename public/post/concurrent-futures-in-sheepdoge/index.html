<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Concurrent Futures in Sheepdoge: How a few lines of code resulted in a 78% performance improvement</title>

<meta name="generator" content="Hugo 0.33" />

<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//fonts.gstatic.com" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all" />
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="/js/scripts.js"></script>
<link rel="shortcut icon" href="/favicon.ico">

<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-101845615-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
			<div class="container container-inner clearfix">
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
					<a class="logo__link" href="/" title="~/mattjmcnaughton/blog" rel="home">
						<h1 class="logo__title">~/mattjmcnaughton/blog</h1>
						<h2 class="logo__tagline">SE@Flatiron Health - Williams College &#39;16 - hackNY &#39;15</h2>
					</a>
				</div>
			</div>
			
<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
		<li class="menu__item"><a class="menu__link" href="/">HOME</a></li>
		<li class="menu__item"><a class="menu__link" href="/about/">ABOUT</a></li>
	</ul>
</nav>


		</header>
		<div class="wrapper clearfix">

<main class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">Concurrent Futures in Sheepdoge: How a few lines of code resulted in a 78% performance improvement</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="post__meta-date" datetime="2017-12-29T00:00:00">2017-12-29</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories__link" href="/categories/deep-dives" rel="category">Deep Dives</a></span>
			</p>
		</header>
		<div class="post__content clearfix">
			<figure class="post__thumbnail">
				<img src="/img/concurrent-futures.jpg" alt="Concurrent Futures in Sheepdoge: How a few lines of code resulted in a 78% performance improvement">
			</figure>
			

<p>For the past couple of months, I&rsquo;ve been working on
<a href="https://github.com/sheepdoge/sheepdoge">Sheepdoge</a>, a tool for managing your
personal Unix machines with Ansible. It&rsquo;s like
<a href="https://github.com/boxen">boxen</a>, but for Ansible.</p>

<p>One new sheepdoge feature I&rsquo;m particularly excited about is the use of <code>concurrent.futures</code>
during <code>sheepdoge install</code>. <code>concurrent.futures</code> provides a high-level API for
executing code asynchronously, making adding thread/process based concurrency
trivial. It is a standard library python module as of 3.2, and is available on python 2.7 through the
<a href="https://pypi.python.org/pypi/futures">futures</a> backport.</p>

<h3 id="why-concurrency-for-sheepdoge-install">Why concurrency for <code>sheepdoge install</code>?</h3>

<p>The <code>sheepdoge install</code> execution path is an excellent candidate for this
concurrency. At a high level, we can think of <code>sheepdoge install</code> like the <code>pip
install -r requirements.txt</code> command. Both take a list of packages hosted at a
remote location and install them into a specified directory on the host machine.</p>

<p>Examining the work profile of <code>sheepdoge install</code> shows it is a good theoretical
candidate for parallelization. Both downloading packages from a remote location
and installing them into a specified directory are I/O heavy operations.</p>

<h3 id="analysis">Analysis</h3>

<p>When we run <code>time sheepdoge install --no-parallel</code>, we get the following:</p>

<pre><code>real 7.115s
user 0.246s
sys  0.244s
</code></pre>

<p>From this output, we know the <code>sheepdoge install --no-parallel</code> command took 7.115s to
execute. However, it was only using the CPU for ~.5s. Given I ran this test on
my laptop, with no other processes consuming a large amount of CPU, I conclude
that the ~6.5 seconds unaccounted for by the summation of user and sys was
time spent doing IO. Additionally, when run sequentially, the <code>install</code> command blocks during
IO operations, meaning the CPU does nothing related to <code>sheepdoge</code> until the next
IO operation completes. In other words, we&rsquo;re not maximizing our utilization of
computing resources.</p>

<p>However, if we run <code>sheepdoge install --parallel</code>, we can keep the CPU working
while we wait for IO operations to finish. Furthermore, we can begin multiple IO
operations at once, since the system is easily able to parallelize these
operations. These optimizations lead to big speed improvements, as we can see
from the output of <code>time sheepdoge install --parallel</code>.</p>

<pre><code>real 1.498s
user 0.272s
sys  0.294s
</code></pre>

<p>As you can see, we&rsquo;ve vastly decreased the time where resources sit idle,
improving overall run time by 78%!</p>

<h3 id="using-concurrent-futures">Using <code>concurrent.futures</code></h3>

<p>Adding concurrency through <code>concurrent.futures</code> is simple. Because each
process we&rsquo;re executing is independent, we only needed to change a couple lines of code
and do not have to worry about locking, memory sharing, etc. Note that
<code>pup.install()</code> is the I/O heavy method responsible for downloading the remote
package and installing it in the proper location.</p>

<p>Without <code>concurrent.futures</code>:</p>

<pre><code>def _execute(self):
    for pup in self._pups_to_install:
        pup.install()
</code></pre>

<p>With <code>concurrent.futures</code>:</p>

<pre><code>from concurrent.futures import ThreadPoolExecutor, wait

...

def _execute(self):
    with ThreadPoolExecutor(max_workers=self._max_workers) as executor:
        install_futures = {
            executor.submit(pup.install) for pup in self._pups_to_install
        }

        wait(install_futures)
</code></pre>

<p>You can find further documentation for all the different ways to utilize <code>concurrent.futures</code>
<a href="https://docs.python.org/3/library/concurrent.futures.html">here</a>.</p>

<h3 id="wrapping-up">Wrapping up</h3>

<p><code>concurrent.futures</code> is a great tool for speeding up I/O heavy portions of your
code, and I hope this post will point you towards some places in your code base
where it could make a performance difference. And if you&rsquo;re interested in using
or contributing to <a href="https://github.com/sheepdoge/sheepdoge">sheepdge</a>, please
get in touch!</p>

		</div>
		

	</article>
	
	
<nav class="post-nav row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/papers-i-love-rsync/" rel="prev"><span class="post-nav__caption">«Previous</span><p class="post-nav__post-title">Papers I Love: Rsync</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/installing-ubuntu-1710-on-macbook-air/" rel="next"><span class="post-nav__caption">Next»</span><p class="post-nav__post-title">Installing Ubuntu 17.10 on MacBook Air</p></a>
	</div>
</nav>

	
<div class="comments">
	<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mattjmcnaughton" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</main>

<aside class="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="//google.com/search">
		<label>
			<span class="screen-reader-text">Search for:</span>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://mattjmcnaughton.com/" />
	</form>
</div>
	

	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/deep-dives">Deep-Dives</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/essays">Essays</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/papers-i-love">Papers-I-Love</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/projects">Projects</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/tutorials">Tutorials</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/mattjmcnaughton" target="_blank">
				<svg class="widget-social__link-icon icon-github" viewBox="0 0 384 374" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:mattjmcnaughton@gmail.com">
				<svg class="widget-social__link-icon icon-mail" viewBox="0 0 416 288" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>mattjmcnaughton@gmail.com</span>
			</a>
		</div>
	</div>
</div>

	
</aside>

	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright">&copy; 2018 ~/mattjmcnaughton/blog. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad theme</a>.</span></p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
</body>
</html>
