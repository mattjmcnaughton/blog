<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Concurrent Futures in Sheepdoge: How a few lines of code resulted in a 78% performance improvement - ~/mattjmcnaughton/blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="~/mattjmcnaughton/blog" rel="home">
				<div class="logo__title">~/mattjmcnaughton/blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/gpg/">
				
				<span class="menu__text">GPG</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Concurrent Futures in Sheepdoge: How a few lines of code resulted in a 78% performance improvement</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2017-12-29T00:00:00">2017-12-29</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/projects/" rel="category">Projects</a>
	</span>
</div></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/concurrent-futures.jpg" alt="Concurrent Futures in Sheepdoge: How a few lines of code resulted in a 78% performance improvement">
		</figure><div class="content post__content clearfix">
			<p>For the past couple of months, I&rsquo;ve been working on
<a href="https://github.com/sheepdoge/sheepdoge">Sheepdoge</a>, a tool for managing your
personal Unix machines with Ansible. It&rsquo;s like
<a href="https://github.com/boxen">boxen</a>, but for Ansible.</p>
<p>One new sheepdoge feature I&rsquo;m particularly excited about is the use of <code>concurrent.futures</code>
during <code>sheepdoge install</code>. <code>concurrent.futures</code> provides a high-level API for
executing code asynchronously, making adding thread/process based concurrency
trivial. It is a standard library python module as of 3.2, and is available on python 2.7 through the
<a href="https://pypi.python.org/pypi/futures">futures</a> backport.</p>
<h3 id="why-concurrency-for-sheepdoge-install">Why concurrency for <code>sheepdoge install</code>?</h3>
<p>The <code>sheepdoge install</code> execution path is an excellent candidate for this
concurrency. At a high level, we can think of <code>sheepdoge install</code> like the <code>pip install -r requirements.txt</code> command. Both take a list of packages hosted at a
remote location and install them into a specified directory on the host machine.</p>
<p>Examining the work profile of <code>sheepdoge install</code> shows it is a good theoretical
candidate for parallelization. Both downloading packages from a remote location
and installing them into a specified directory are I/O heavy operations.</p>
<h3 id="analysis">Analysis</h3>
<p>When we run <code>time sheepdoge install --no-parallel</code>, we get the following:</p>
<pre tabindex="0"><code>real 7.115s
user 0.246s
sys  0.244s
</code></pre><p>From this output, we know the <code>sheepdoge install --no-parallel</code> command took 7.115s to
execute. However, it was only using the CPU for ~.5s. Given I ran this test on
my laptop, with no other processes consuming a large amount of CPU, I conclude
that the ~6.5 seconds unaccounted for by the summation of user and sys was
time spent doing IO. Additionally, when run sequentially, the <code>install</code> command blocks during
IO operations, meaning the CPU does nothing related to <code>sheepdoge</code> until the next
IO operation completes. In other words, we&rsquo;re not maximizing our utilization of
computing resources.</p>
<p>However, if we run <code>sheepdoge install --parallel</code>, we can keep the CPU working
while we wait for IO operations to finish. Furthermore, we can begin multiple IO
operations at once, since the system is easily able to parallelize these
operations. These optimizations lead to big speed improvements, as we can see
from the output of <code>time sheepdoge install --parallel</code>.</p>
<pre tabindex="0"><code>real 1.498s
user 0.272s
sys  0.294s
</code></pre><p>As you can see, we&rsquo;ve vastly decreased the time where resources sit idle,
improving overall run time by 78%!</p>
<h3 id="using-concurrentfutures">Using <code>concurrent.futures</code></h3>
<p>Adding concurrency through <code>concurrent.futures</code> is simple. Because each
process we&rsquo;re executing is independent, we only needed to change a couple lines of code
and do not have to worry about locking, memory sharing, etc. Note that
<code>pup.install()</code> is the I/O heavy method responsible for downloading the remote
package and installing it in the proper location.</p>
<p>Without <code>concurrent.futures</code>:</p>
<pre tabindex="0"><code>def _execute(self):
    for pup in self._pups_to_install:
        pup.install()
</code></pre><p>With <code>concurrent.futures</code>:</p>
<pre tabindex="0"><code>from concurrent.futures import ThreadPoolExecutor, wait

...

def _execute(self):
    with ThreadPoolExecutor(max_workers=self._max_workers) as executor:
        install_futures = {
            executor.submit(pup.install) for pup in self._pups_to_install
        }

        wait(install_futures)
</code></pre><p>You can find further documentation for all the different ways to utilize <code>concurrent.futures</code>
<a href="https://docs.python.org/3/library/concurrent.futures.html">here</a>.</p>
<h3 id="wrapping-up">Wrapping up</h3>
<p><code>concurrent.futures</code> is a great tool for speeding up I/O heavy portions of your
code, and I hope this post will point you towards some places in your code base
where it could make a performance difference. And if you&rsquo;re interested in using
or contributing to <a href="https://github.com/sheepdoge/sheepdoge">sheepdge</a>, please
get in touch!</p>

		</div>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/getting-started-contributing-to-open-source-projects/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Getting Started Contributing to Popular Open-Source Projects</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/papers-i-love-rsync/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">A Closer Look at Rsync</p></a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/mattjmcnaughton" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:me@mattjmcnaughton.com">
				<svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>me@mattjmcnaughton.com</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 ~/mattjmcnaughton/blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>