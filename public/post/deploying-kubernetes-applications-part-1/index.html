<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>(Part 1) Deploying Kubernetes&#39; Applications: The Solution - ~/mattjmcnaughton/blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="~/mattjmcnaughton/blog" rel="home">
				<div class="logo__title">~/mattjmcnaughton/blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/gpg/">
				
				<span class="menu__text">GPG</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">(Part 1) Deploying Kubernetes&#39; Applications: The Solution</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2019-01-29T00:00:00">2019-01-29</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/projects/" rel="category">Projects</a>
	</span>
</div></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/deploy-solution.jpg" alt="(Part 1) Deploying Kubernetes&#39; Applications: The Solution">
		</figure><div class="content post__content clearfix">
			<p>In the first blog post in <a href="/post/deploying-kubernetes-applications-part-0/">this
series</a>, we examined how our
previous deployment strategy of running <code>kubectl apply -f</code> on static manifests
did not meet our increasingly complex requirements for our strategy/system for deploying
Kubernetes' applications. In the second, and final, post in this mini-series,
we&rsquo;ll outline the new deployment strategy and how it fulfills our requirements.</p>
<h1 id="the-new-system">The new system</h1>
<iframe src="https://giphy.com/embed/xT5LMyJumn03ezhDvW" width="480"
height="362" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/season-16-the-simpsons-16x2-xT5LMyJumn03ezhDvW">via
GIPHY</a></p>
<p>Our new deployment strategy makes use of <a href="https://github.com/helm/helm">Helm</a>,
a popular tool in the Kubernetes ecosystem which describes itself as &ldquo;a tool
that streamlines installing and managing Kubernetes applications.&rdquo;</p>
<p>Helm manages &ldquo;Charts&rdquo;, which are packages of templated Kubernetes resources. For example,
a Chart might comprise of Deployment, Service, and Ingress objects. When
interacting with a Chart, we specify variables, which help fill in the template of
our preconfigured Kubernetes' resources. Returning to our previous example, our
Chart might support specifying variable indicating the number of replica Pods the Deployment should
manage.</p>
<p>Once we&rsquo;ve written a Chart, we can interact with it in a number of different
ways. If we deploy another part of Helm called <a href="https://docs.helm.sh/glossary/#tiller">Tiller</a>
to our Kubernetes cluster, we can use the <code>helm</code> client to directly install
Charts on our cluster. See <a href="https://docs.bitnami.com/kubernetes/how-to/create-your-first-helm-chart/">this
tutorial</a>
for an example of a workflow which relies on Tiller. Alternatively, we could use
the <code>helm template</code> command to generate yaml manifest files for the Kubernetes'
resources our chart defines. <code>helm template</code> allows us to specify the variables
for the manifest templates. We can then apply the output of <code>helm template</code> via
<code>kubectl apply -f</code>.</p>
<p>For example, to deploy our
<a href="https://github.com/mattjmcnaughton/personal-k8s/tree/master/applications/blog">blog</a>
via this strategy, we can run the following:</p>
<pre tabindex="0"><code>helm template -f HELM-VARIABLE_FILE.yaml | kubectl apply -f -
</code></pre><p>While the former method utilizes more of Helm&rsquo;s functionality and abilities, we
decided on the latter method for a couple of different reasons. First, in the
<code>helm template</code> method, we don&rsquo;t need to perform the non-trivial task of
<a href="https://github.com/helm/helm/blob/master/docs/securing_installation.md">securely installing</a>
Tiller on our cluster. Additionally, the latter method is less complex in that
we don&rsquo;t need to worry about how Tiller operates or how Helm manages &ldquo;releases&rdquo;
and &ldquo;installs&rdquo; of Charts. Rather, we can just use the <code>kubectly apply -f</code> tool
we are familiar with. Doing so retains our Git repo as the source of
truth. Finally, the <a href="https://github.com/helm/community/blob/master/helm-v3/000-helm-v3.md">Helm 3 Design
Proposal</a>
gets rid of Tiller entirely, so it seems like there may be a benefit to waiting a
couple of months to get more insight and clarity on Tiller&rsquo;s role going forward. Nothing about choosing the
<code>helm template</code> option prevents us from pursuing the <code>tiller</code> option later
should we decide its beneficial.</p>
<h2 id="how-our-new-system-fulfills-our-requirements">How our new system fulfills our requirements</h2>
<p>With a good sense of our new deployment system, we can now evaluate whether it
meets our listed requirements.</p>
<iframe src="https://giphy.com/embed/l4EpblDY4msVtKAOk" width="480" height="270"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/thenextstep-l4EpblDY4msVtKAOk">via GIPHY</a></p>
<p>Our first requirement was that we must be able to
<strong>write a manifest once, and deploy it in multiple environments with minimal
effort and duplication</strong>. Our new system easily meets this requirement, as we
can easily use Helm&rsquo;s variables to write a manifest once, and then deploy it
with different variables depending on the environment. In practice, we define a
<a href="https://github.com/mattjmcnaughton/personal-k8s/tree/master/applications/_helm-environments">helm-environments</a>
directory, and we then include
<code>_helm-environments/(development|production).yaml</code> every time we deploy an
application. In addition to setting other variables, these files set <code>environment=(development|production)</code>, and we can
then additionally use the <code>environment</code> variable to determine whether to include
certain manifest components. For example, we only want to create AWS specific
resources in production.</p>
<p>Our next requirement was that, since these applications are suitably complex, we want to be
able to <strong>define multiple, tunable parameters and share them across all the
manifests comprising an application</strong>. A Chart&rsquo;s function is to group multiple
manifests into a single application, and when we pass variables to the Chart,
they are available to all of the manifests. So this requirement is met.</p>
<p>An additional requirement is that we want <strong>interactions with
secrets to be secure and simple</strong>. In our new system, each Chart containing
secrets has two files: <code>secret-values.yaml</code> and <code>secret-values.yaml.sample</code>. The
former contains all the Charts' secrets and we include it with the <code>-f</code> flag whenever we run <code>helm template</code>. It is not checked into source control. The
<code>secret-values.yaml.sample</code> contains just a list of the secrets we need to
define, not the actual values for those secrets. It is checked into source
control, as it doesn&rsquo;t contain any sensitive information. After cloning the repo
for the first time, we can convert <code>secret-values.yaml.sample</code> to
<code>secret-values.yaml</code> via a simple <code>envsubst</code> command, as described in our
Grafana deployment&rsquo;s
<a href="https://github.com/mattjmcnaughton/personal-k8s/blob/master/applications/grafana/README.md">README.md</a>.
With this strategy, our secrets are in one isolated location, and restricted to
the developer&rsquo;s local machines.</p>
<p>As a penultimate requirement, our deployment strategy must support <strong>grouping a complex application&rsquo;s
components together conceptually without unnecessary duplication and sharing variables between them</strong>.
For example, if we have a web app A and web app B, each of which require a
Postgres database, we should be able to deploy web app A with its uniquely
configured database and web app B with its uniquely configured database, yet
maintain only one source of truth for how we deploy a generic database. Helm
supports this grouping of application components via <a href="https://docs.helm.sh/developing_charts/#chart-dependencies">Chart
Dependencies</a>.</p>
<p>Finally, we require the ability to <strong>leverage already existing community investments to deploy
applications via Kubernetes</strong>. Helm easily supports this via their massive
<a href="https://github.com/helm/charts">community repository</a> of Charts. We can either
deploy these Charts directly, or we can use them as a source of reference.</p>
<h1 id="migrating-from-our-old-system-to-our-new-system">Migrating from our old system to our new system</h1>
<p>We convinced ourselves of this new deployment system&rsquo;s merit. But, we still
needed to convert all of our <a href="https://github.com/mattjmcnaughton/personal-k8s/tree/master/applications">personal-k8s
applications</a> to use the new deployment strategy.</p>
<iframe src="https://giphy.com/embed/14wXMGbHjXK2k0" width="480" height="480"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/boy-adventure-14wXMGbHjXK2k0">via GIPHY</a></p>
<p>Fortunately, the process for doing so was fairly trivial, and only requires
the following steps:</p>
<ol>
<li>Create the helm chart with <code>helm create APP_NAME</code>.</li>
<li>Copy over the static manifests from the old deployment strategy into the
<code>templates</code> directory in the Chart.</li>
<li>Extract out variables/secrets into <code>values.yaml</code> and <code>secret-values.yaml</code>
respectively.</li>
<li>Deploy the application and ensure nothing meaningful changed.</li>
</ol>
<p>For a more hands on example,
this <a href="https://github.com/mattjmcnaughton/personal-k8s/commit/b74a4502e294ca6caef0d6633151a5fc9a288273">diff</a>
shows an example of the work required to migrate Grafana from the old deployment
system to the new deployment system.</p>
<h1 id="guidelines-for-our-new-system">Guidelines for our new system</h1>
<iframe src="https://giphy.com/embed/liz1CsrJ5cF5m" width="480" height="262"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/haters-teen-titans-go-liz1CsrJ5cF5m">via
GIPHY</a></p>
<p>We used the development of our new deployment strategy as an opportunity to add
more formal guidelines around using Helm to deploy an application to our k8s
cluster. For example, we want all of our Kubernetes objects to share common label keys for the
concepts of Name, Environment, etc. You can see
the entire list of guidelines in the <a href="https://github.com/mattjmcnaughton/personal-k8s/blob/master/design/helm-deploy.md">design
docs</a>.
Formally listing these guidelines helps us ensure we continue to deploy
applications in a uniform manner, which only increases in importance as we
deploy more and more applications.</p>
<h1 id="conclusion">Conclusion</h1>
<p>To summarize, in <a href="post/deploying-kubernetes-applications-part-0/">part 0</a>, we
outlined our requirements for deploying our increasingly complex
applications on Kubernetes and verified our previous system of deployment failed
to meet these requirements. In this blog post, we outlined our new system for
deploying applications, and verified that it met all of our requirements. We
then briefly discussed the process of migrating all of our applications from the
old system to the new system, and how we will preserve cohesion in the new
system going forward. I&rsquo;m looking forward to utilizing this new deployment
system to deploy some exciting new applications. And in fact, an upcoming blog
post will discuss how we deployed <a href="https://github.com/mattjmcnaughton/personal-k8s/tree/master/applications/next-cloud">NextCloud on our Kubernetes
cluster</a>, which
would&rsquo;ve been substantially more difficult with our old deployment strategy.
Looking forward to it!</p>
<p>P.S. My apologies for the delay since my last post. I took a little
break from Kubernetes and blogging to code
my way through <a href="https://interpreterbook.com/">Writing An Interpreter In Go</a>. I
just wrapped up the last chapter yesterday, so hopefully I&rsquo;ll return to a
more frequent cadence going forward.</p>

		</div>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/deploying-kubernetes-applications-part-0/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">(Part 0) Deploying Kubernetes&#39; Applications: The Problem</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/saving-money-while-maintaining-performance-with-tolerations-on-k8s/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Saving Money While Maintaining Performance With Tolerations on k8s</p></a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/mattjmcnaughton" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:me@mattjmcnaughton.com">
				<svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>me@mattjmcnaughton.com</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 ~/mattjmcnaughton/blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>