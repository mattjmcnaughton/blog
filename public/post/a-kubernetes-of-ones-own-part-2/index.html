<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>(Part 2) A Kubernetes of One&#39;s Own: Can We Build It? Yes We Can! - ~/mattjmcnaughton/blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="~/mattjmcnaughton/blog" rel="home">
				<div class="logo__title">~/mattjmcnaughton/blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/gpg/">
				
				<span class="menu__text">GPG</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">(Part 2) A Kubernetes of One&#39;s Own: Can We Build It? Yes We Can!</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2018-09-10T00:00:00">2018-09-10</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/projects/" rel="category">Projects</a>
	</span>
</div></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/construction.jpeg" alt="(Part 2) A Kubernetes of One&#39;s Own: Can We Build It? Yes We Can!">
		</figure><div class="content post__content clearfix">
			<p>In my last <a href="/post/a-kubernetes-of-ones-own-part-1">blog post</a>, we outlined the
different methods of creating and maintaining a Kubernetes cluster, before
deciding on <a href="https://github.com/kubernetes/kops">Kops</a>. In this blog post,
we&rsquo;ll actually create the cluster using Kops. I&rsquo;ll provide source code and
instructions, so by the end of this post, you can have your own Kubernetes
cluster!</p>
<p>This tutorial is strongly based on Kops <a href="https://github.com/kubernetes/kops/blob/master/docs/aws.md">AWS
tutorial</a>, although
its even simplifier because I&rsquo;ve written some generic terraform configurations
which simplify initial AWS configuration.</p>
<p><strong>Note, following this tutorial creates AWS resources that cost ~$100 a month.</strong></p>
<h2 id="step-0-prerequirements">Step 0: Prerequirements</h2>
<p>This tutorial assumes that you have an AWS account in which we can launch our
Kubernetes cluster. Additionally, it assumes that you&rsquo;ve installed
<a href="https://github.com/kubernetes/kops">kops</a>,
<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a>,
and <a href="https://www.terraform.io/downloads.html">terraform</a>.</p>
<p>It also assumes you&rsquo;ve cloned my
<a href="https://github.com/mattjmcnaughton/personal-k8s">personal-k8s</a> project onto
your local machine.</p>
<h2 id="step-1-decision-time-and-aws-setup">Step 1: Decision Time and AWS setup</h2>
<iframe src="https://giphy.com/embed/l41YtfUCfOVUkiYcU" width="480" height="270"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/masterchef-chefs-home-cooks-masterchef-season-7-l41YtfUCfOVUkiYcU">via
GIPHY</a></p>
<p>Before we can use Kops with AWS, we need to create the AWS resources Kops needs
to function. And before we can create the AWS resources Kops needs to function, we need to make
some decisions. Specifically, what is the domain in which we&rsquo;ll host all k8s
DNS, and in which s3 bucket should kops store its state.</p>
<p>With the answers to those questions in mind, you can follow the
<a href="https://github.com/mattjmcnaughton/personal-k8s/tree/master/bootstrap#instructions">instructions</a>
section of
<a href="https://github.com/mattjmcnaughton/personal-k8s/tree/master/bootstrap">personal-k8s/bootstrap</a>.
The instructions indicate when you need to parameterize the existing code with
your preferred values.</p>
<p>Completing these instructions will create all the AWS resources that Kops needs,
meaning that we&rsquo;re now ready to create our Kubernetes cluster!</p>
<h2 id="step-2-create-your-cluster">Step 2: Create Your Cluster</h2>
<iframe src="https://giphy.com/embed/OMeGDxdAsMPzW" width="480" height="280"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/funny-OMeGDxdAsMPzW">via GIPHY</a></p>
<p>We are now ready to create the Kubernetes cluster. Remember, before we undertake
any operation involving Kops, we want to run <code>source /PATH/TO/personal-k8s/bootstrap/env.sh</code>, which will populate useful environment
variables.</p>
<p>Now, we can run the following command to perform the first step in creating our
Kubernetes cluster. Note, this command will create a cluster configuration, but
not yet generate any AWS resources.</p>
<pre tabindex="0"><code>kops create cluster --name=$NAME --state=$KOPS_STATE_STORE --zones=$AZ --ssh-public-key PATH_TO_YOUR_PUBLIC_KEY
</code></pre><p>This initial cluster configuration presumes a number of sensible defaults. You
can examine them all with the following command:</p>
<pre tabindex="0"><code>kops edit cluster --name=$NAME
</code></pre><p><a href="https://github.com/kubernetes/kops/tree/master/docs">Kops documentation</a>
provides instructions on modifying these default values, but for our initial use
case they should work perfectly. One important note is that by default, Kops
creates machines/DNS records that are publicly accessible. Kubernetes has additional
security mechanisms preventing unwanted access, so I&rsquo;m comfortable with the
machines being initially publicly accessible. You will have to make
the decision of whether that&rsquo;s something with which you are comfortable. If not, Kops
does support using private DNS records and hosting machines in a private subnet. I
have not yet had the chance to experiment with them, but hope to in the future.</p>
<p>If you&rsquo;re happy with your cluster&rsquo;s configuration values, then we can instruct
Kops to create the physical resources.</p>
<pre tabindex="0"><code>kops update cluster ${NAME} --yes
</code></pre><p>Kops will perform a whole bunch of operations to create the Kubernetes cluster
on AWS. After these operations are complete, Kops will update your <code>~/.kube/config</code> file with
credentials for accessing the cluster. As a result, if you run <code>kubectl get nodes</code>, you should see your cluster&rsquo;s nodes. Try launching a simple
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">deployment</a>
to verify everything is working as expected.</p>
<pre tabindex="0"><code>kubectl run test-deployment --image=nginx --replicas=1
</code></pre><p>Running <code>kubectl get pods</code> should return a <code>test-deployment-SOME_UID</code> pod with
a status of <code>Running</code>.</p>
<h2 id="step-3-update-your-cluster">Step 3: Update Your Cluster</h2>
<p>Kops provides easy tooling for updating your cluster. You can run <code>kops edit cluster ${NAME}</code> to edit the cluster configuration, followed by <code>kops update cluster ${NAME}</code> to preview the changes, and <code>kops update cluster ${NAME} --yes</code>
to apply them. See <a href="https://github.com/kubernetes/kops/blob/master/docs/changing_configuration.md">Kops
documentation</a>
for more details.</p>
<p>Kops additionally provides the following useful command to ensure your cluster
is working as expected.</p>
<pre tabindex="0"><code>kops validate cluster
</code></pre><h2 id="step-hopefully-never-deleting-your-cluster">Step Hopefully Never: Deleting Your Cluster</h2>
<p>Hopefully you will continue to use this Kubernetes cluster forever, but should
you need to delete all of the AWS resources Kops created, Kops provides tooling
to do so.</p>
<p>First, run the following command to preview specifically what Kops will delete.</p>
<pre tabindex="0"><code>kops delete cluster --name ${NAME}
</code></pre><p>If you are comfortable deleting everything output in the previous command, you
can run the following command to delete your Kubernetes cluster.</p>
<pre tabindex="0"><code>kops delete cluster --name ${NAME} --yes
</code></pre><p>The <a href="https://github.com/mattjmcnaughton/personal-k8s/tree/master/bootstrap">personal-k8s/bootstrap</a>
documentation provides instructions for deleting all of the AWS resources you
created to support Kops.</p>
<h1 id="wrapping-up">Wrapping Up</h1>
<iframe src="https://giphy.com/embed/l2JJA5fbJ5o328Odi" width="480" height="258"
frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a
href="https://giphy.com/gifs/cravetvcanada-funny-comedy-30-rock-l2JJA5fbJ5o328Odi">via
GIPHY</a></p>
<p>Congrats, you did! You now have a Kubernetes cluster of your own running on AWS.
If you&rsquo;re looking for an application to start running on this cluster, a
static website (like a blog) is a great first choice&hellip; and coincidentally, my
next blog post will examine exactly that :)</p>

		</div>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/a-kubernetes-of-ones-own-part-1/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">(Part 1) A Kubernetes of One&#39;s Own: I Can Haz Cluster?</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/hosting-static-blog-on-kubernetes/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Hosting Static Blog on Kubernetes</p></a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/mattjmcnaughton" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:me@mattjmcnaughton.com">
				<svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>me@mattjmcnaughton.com</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 ~/mattjmcnaughton/blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>