<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>A Closer Look at Rsync - ~/mattjmcnaughton/blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="~/mattjmcnaughton/blog" rel="home">
				<div class="logo__title">~/mattjmcnaughton/blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/gpg/">
				
				<span class="menu__text">GPG</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">A Closer Look at Rsync</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2017-12-29T00:00:00">2017-12-29</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/essays/" rel="category">essays</a>
	</span>
</div></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/rsync.png" alt="A Closer Look at Rsync">
		</figure><div class="content post__content clearfix">
			<p>It&rsquo;s not often that academia analyzes the unix tools we use everyday.
But <code>rsync</code> is one fortunate exception as <a href="https://en.wikipedia.org/wiki/Andrew_Tridgell">Andrew
Tridgell</a> not only wrote <code>rsync</code>
while pursuing his PhD, but also published a short and accessible
<a href="https://www.andrew.cmu.edu/course/15-749/READINGS/required/cas/tridgell96.pdf">paper</a>
outlining its inner workings. While I&rsquo;d highly encourage reading the entire paper, I took away
one major tl:dr; from the <code>rsync</code> algorithm: <strong>be lazy</strong>.
This lesson will be applicable anytime I write performance conscious code.</p>
<h2 id="algorithm-overview">Algorithm Overview</h2>
<p>Before diving into the benefits of being lazy, we must understand rsync&rsquo;s goals and
implementation. <code>rsync</code> is an algorithm for updating a file on machine A to be
identical to a file on machine B. Tridgell optimizes for when the connection
between machine A and machine B is high-latency and when the two files are
similar.</p>
<p>To copy file <code>a</code> from machine <code>A</code> to file <code>b</code> on machine <code>B</code>, the <code>rsync</code>
algorithm conducts the following high-level steps.</p>
<ol>
<li>Machine <code>B</code> splits file <code>b</code> into non-overlapping blocks of size <code>S</code> bytes.</li>
<li>For each block, <code>B</code> calculates a weak checksum and a strong checksum.</li>
<li>Machine <code>B</code> sends the checksums to machine <code>A</code>.</li>
<li>Machine <code>A</code> searches through all possible blocks of size <code>S</code> in file <code>a</code> to
find blocks which have weak and strong checksums equal to one of the blocks
on <code>B</code>.</li>
<li>Machine <code>A</code> uses the knowledge of equivalent blocks to send machine <code>B</code> a
sequence of instructions for constructing a copy of <code>A</code>. It only sends <code>B</code>
data which it does not have, so if a block in <code>a</code> is a match for a block on
<code>b</code>, machine <code>A</code> will not transmit the block to machine <code>B</code>.</li>
</ol>
<p>If you&rsquo;re interested in greater detail, the
<a href="https://www.andrew.cmu.edu/course/15-749/READINGS/required/cas/tridgell96.pdf">paper</a>
further explains the algorithm, as well as detailing the underlying math and
providing empirical analysis.</p>
<h2 id="be-lazy">Be Lazy</h2>
<iframe src="https://giphy.com/embed/3o6MbedpC11J84sQ4o" width="480" height="362" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/season-16-the-simpsons-16x9-3o6MbedpC11J84sQ4o">via GIPHY</a></p>
<p>In order for the <code>rsync</code> algorithm to operate efficiently, it must quickly
compare all possible blocks of size <code>S</code> in file <code>a</code> to the set of
non-overlapping blocks of size <code>S</code> in file <code>b</code>. To visualize, imagine file <code>a</code>
contains <code>1234567890</code>, file <code>b</code> contains <code>2345678901</code> and <code>S</code> is two characters.
From step 1 of the algorithm, the blocks from file <code>b</code> are <code>23</code>, <code>45</code>, <code>67</code>,
<code>89</code>, and <code>01</code>. To accurately compare file <code>a</code> to file <code>b</code>, we not only need to
compare <code>12</code> on file <code>a</code> to <code>23</code> on file <code>b</code>, but also <code>23</code>, <code>34</code>, <code>45</code>&hellip; on
file <code>a</code> to <code>23</code> on file <code>b</code>. However, we don&rsquo;t want to do an expensive calculation for each
possible block on <code>a</code>. Rather, we want to a perform a calculation which allows
us to take our checksum for block <code>i,j</code> and with a small amount of work, find
the checksum of block <code>i+1,j+1</code>.</p>
<p>Tridgell accomplishes this through the weak checksum calculated in steps 2 and 4
of the algorithm. As he discusses in the paper, given <code>weak-checksum(i,j)</code> and values
<code>i,j+1</code>, we need to do little additional work to find <code>weak-checksum(i+1,j+1)</code>.
Because of this efficiency, the algorithm can very quickly find the weak checksum for
all possible blocks in <code>a</code>.</p>
<p>However, the weak checksum is not perfect. In certain scenarios, it will give
false positives and say two unequal blocks are equal.
To be absolutely certain two blocks are equal, we need
to calculate and compare the strong checksum. However, the strong checksum is
more expensive to calculate, and the value of <code>strong-checksum(i,j)</code> gives us no
insight into the value of <code>strong-checksum(i+1,j+1)</code>.</p>
<p>Tridgell cleverly works around this by <strong>being lazy</strong>, as <code>rsync</code> does the hard
work of calculating and comparing the strong checksums only if the weak
checksums are equal. The algorithm carefully avoids doing expensive operations
until they are absolutely necessary by utilizing a cheap approximation, with the
potential for false positives. This technique is applicable to almost any situation involving expensive
computation.</p>

		</div>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/concurrent-futures-in-sheepdoge/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Concurrent Futures in Sheepdoge: How a few lines of code resulted in a 78% performance improvement</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/installing-ubuntu-1710-on-macbook-air/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Installing Ubuntu 17.10 on MacBook Air</p></a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/mattjmcnaughton" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:me@mattjmcnaughton.com">
				<svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>me@mattjmcnaughton.com</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 ~/mattjmcnaughton/blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>